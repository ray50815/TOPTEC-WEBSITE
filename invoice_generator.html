<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INVOICE 自動生成器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Times New Roman', 'Inter', 'Noto Sans TC', serif;
            -webkit-print-color-adjust: exact;
        }
        .invoice-box {
            border: 1px solid #000;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.15);
            font-size: 12px; /* Smaller font size to match example */
            line-height: 1.4;
            color: #000;
        }
        .invoice-table, .packing-table {
            border-collapse: collapse;
        }
        .invoice-table th, .invoice-table td,
        .packing-table th, .packing-table td {
            border: 1px solid #000;
            padding: 5px 8px;
            text-align: center;
        }
        .packing-table th {
            background-color: #f2f2f2;
        }
        .invoice-table .no-border { border: none; }
        .invoice-table .border-top { border-top: 1px solid #000; }
        .invoice-table .border-bottom { border-bottom: 1px solid #000; }
        .invoice-table .border-left { border-left: 1px solid #000; }
        .invoice-table .border-right { border-right: 1px solid #000; }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .modal-backdrop {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0,0,0,0.5); display: flex;
            align-items: center; justify-content: center; z-index: 1000;
        }
        .modal-content {
            background: white; padding: 2rem; border-radius: 0.75rem;
            max-width: 90%; width: 600px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        @media print {
            body { font-family: 'Times New Roman', serif; }
            body * { visibility: hidden; }
            #invoice-preview, #invoice-preview * { visibility: visible; }
            #invoice-preview {
                position: absolute; left: 0; top: 0; width: 100%;
                border: none; box-shadow: none;
            }
            .no-print { display: none; }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-5xl mx-auto">
        <div class="bg-white p-8 rounded-xl shadow-lg mb-6 no-print">
            <h1 class="text-2xl font-bold text-gray-800 mb-2">INVOICE/PACKING 自動生成器</h1>
            <p class="text-gray-600 mb-6">請選擇交易類型並輸入資訊，系統將自動處理並生成文件。</p>
            
            <div class="grid md:grid-cols-3 gap-6">
                <div>
                    <label for="company" class="block text-sm font-medium text-gray-700 mb-1">選擇交易</label>
                    <select id="company" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                        <optgroup label="賣出 (Sales)">
                            <option value="anxin">An Xin (鞍鑫) (USD)</option>
                            <option value="anxin_eur">An Xin (鞍鑫) (EUR)</option>
                            <option value="winteam">WIN TEAM (旺緹) (USD)</option>
                            <option value="styleup">StyleUp (USD)</option>
                            <option value="converge">Converge (聚合雲) (USD)</option>
                        </optgroup>
                        <optgroup label="買進 (Purchase)">
                             <option value="buy_foreign_usd">向外國公司買進 (USD)</option>
                             <option value="buy_foreign_eur">向外國公司買進 (EUR)</option>
                        </optgroup>
                    </select>
                </div>
                <div>
                    <label for="date" class="block text-sm font-medium text-gray-700 mb-1">水單日期 (格式: YYYYMMDD)</label>
                    <input type="text" id="date" placeholder="例如: 20241206" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                     <div class="mt-2 flex items-start space-x-4">
                        <div class="flex items-center">
                            <input id="date-adjust-checkbox" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <label for="date-adjust-checkbox" class="ml-2 block text-sm text-gray-900">發票日期提前5天</label>
                        </div>
                         <div class="flex items-center hidden" id="flexible-quantity-container">
                            <input id="flexible-quantity-checkbox" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <label for="flexible-quantity-checkbox" class="ml-2 block text-sm text-gray-900">啟用彈性數量</label>
                        </div>
                    </div>
                </div>
                <div>
                    <label for="totalAmount" class="block text-sm font-medium text-gray-700 mb-1">總金額</label>
                    <input type="number" id="totalAmount" placeholder="例如: 153900" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                </div>
            </div>
            <div class="mt-6 flex justify-end items-center space-x-4">
                <button id="findNextBtn" class="bg-blue-100 text-blue-800 font-bold py-2 px-6 rounded-lg hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition hidden">
                    尋找下個組合 🔃
                </button>
                <button id="generateBtn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-transform transform hover:scale-105">
                    生成文件
                </button>
            </div>
            <div id="status" class="mt-4 text-center"></div>
        </div>

        <div id="invoice-wrapper" class="hidden">
            <div class="bg-white p-8 rounded-xl shadow-lg invoice-box" id="invoice-preview">
                <!-- Content will be injected here -->
            </div>
            <div class="mt-6 text-center space-x-2 md:space-x-4 no-print flex flex-wrap justify-center gap-2">
                <button id="printBtn" class="bg-gray-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-800">列印</button>
                <button id="downloadBtn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">下載 Excel</button>
                <button id="packingListBtn" class="bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700">✨ 產生裝箱單</button>
                <button id="emailBtn" class="bg-orange-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-orange-600">✨ 草擬郵件</button>
            </div>
        </div>
    </div>
    
    <!-- Modals for Gemini Features -->
    <div id="packingListModal" class="modal-backdrop hidden"></div>
    <div id="emailModal" class="modal-backdrop hidden"></div>

    <script>
        // --- GLOBAL STATE ---
        let currentInvoiceData = {};
        let generationArgs = {};
        let foundSolutions = [];
        let currentSolutionIndex = 0;
        const API_KEY = "AIzaSyADI9bFMSMtdj_xIPLt_wQovDKY21uDkeI";
        
        // --- COMPANY & PRICE CONFIGS ---
        const TOPTEC_GLOBAL = {
            name: "TOPTEC GLOBAL PTE. LTD.(S.G.)",
            address: "711 Geylang Road #03-01 Oriental Venture\nBuilding Singapore 389626",
            tel: "65-6547-8633"
        };

        const companyConfigs = {
            // --- SELL CONFIGS ---
            'anxin': {
                type: 'sell', name: "An Xin Enterprise Co.,Ltd", address: "9F., No. 222, Sec. 1, Fuxing S. Rd., Da’an Dist., Taipei City ,106458,Taiwan (R.O.C.)", tel: "886-968-353738", country: "TAIWAN", priceTerm: "FOB TAIPEI", paymentTerms: "T/T", currencySymbol: 'US$', currencyCode: 'USD',
                products: [ { id: 'JC-108A-08', desc: 'Bottom Housing-JC-8GB', price: 1.65 }, { id: 'JC-108B-08', desc: 'Bottom Housing-JC-8GB', price: 1.55 }, { id: 'JC-109A-08', desc: 'Bottom Housing-JC-8GB', price: 2.10 } ],
                findQuantities: findQuantitiesAnXinUSD, extraInvoiceLines: (p) => `<tr class="h-4"><td class="no-border"></td><td class="no-border"></td><td class="no-border"></td><td class="no-border"></td></tr>`,
            },
            'anxin_eur': {
                type: 'sell', name: "An Xin Enterprise Co.,Ltd", address: "9F., No. 222, Sec. 1, Fuxing S. Rd., Da’an Dist., Taipei City ,106458,Taiwan (R.O.C.)", tel: "886-968-353738", country: "TAIWAN", priceTerm: "FOB TAIPEI", paymentTerms: "T/T", currencySymbol: '€', currencyCode: 'EUR',
                products: [ { id: 'JC-108A-08', desc: 'Bottom Housing-JC-8GB', price: 1.55 }, { id: 'JC-108B-08', desc: 'Bottom Housing-JC-8GB', price: 1.45 }, { id: 'JC-109A-08', desc: 'Bottom Housing-JC-8GB', price: 2.00 } ],
                findQuantities: findQuantitiesAnXinEur, extraInvoiceLines: (p) => `<tr class="h-4"><td class="no-border"></td><td class="no-border"></td><td class="no-border"></td><td class="no-border"></td></tr>`,
            },
            'winteam': {
                type: 'sell', name: "WIN TEAM CO.,LTD.", address: "NO.117,KANGLE ST.,NEIHU DIST., Taipei City ,114038,Taiwan (R.O.C.)", tel: "886-2-26339869", country: "TAIWAN", priceTerm: "FOB TAIPEI", paymentTerms: "T/T", currencySymbol: 'US$', currencyCode: 'USD',
                products: [ { id: 'K 2 - 0 6', desc: 'Intelligent cooking machine', price: 9000 }, { id: 'J D J - A 1', desc: 'Fully automatic intelligent egg fryer', price: 3000 }, { id: 'Accessories', desc: 'Feeding boxes and accessories', price: 600 } ],
                findQuantities: findQuantitiesWinTeam, extraInvoiceLines: () => ``,
            },
            'styleup': {
                type: 'sell', name: "StyleUp Technology Co., Ltd.", address: "10 F., No. 150, Sec. 2, Nanjing E. Rd., Zhongshan Dist., Taipei City 104695, Taiwan (R.O.C.)", tel: "886-989-553839", country: "TAIWAN", priceTerm: "FOB TAIPEI", paymentTerms: "T/T", currencySymbol: 'US$', currencyCode: 'USD',
                products: [ { id: 'JC-108A-08', desc: 'Bottom Housing-JC-8GB', price: 1.65 }, { id: 'JC-108B-08', desc: 'Bottom Housing-JC-8GB', price: 1.60 }, { id: 'JC-109A-08', desc: 'Bottom Housing-JC-8GB', price: 2.10 } ],
                findQuantities: findQuantitiesStyleUp, extraInvoiceLines: (p) => `<tr class="h-4"><td class="no-border"></td><td class="no-border"></td><td class="no-border"></td><td class="no-border"></td></tr>`,
            },
            'converge': {
                type: 'sell', name: "Converge Cloud Co., Ltd.", address: "Morgan Tower, Floor 35th Unit 08B-11, Street Sopheak Mongkul,\nPhum 14, Sangkat Tonle Bassac, Khan Chamka Mon, Phnom Penh, Cambodia", tel: "088-590-9999", country: "Cambodia", priceTerm: "", paymentTerms: "T/T-USD/USTD", currencySymbol: 'US$', currencyCode: 'USD',
                products: [ { id: 'AI Cloud storage and advertising service charges', desc: '', price: 0 } ],
                findQuantities: (totalAmount) => ([{ q1: 1 }]), extraInvoiceLines: () => ``,
            },
            // --- BUY CONFIGS ---
            'buy_foreign_usd': {
                type: 'buy', name: "外國公司 (Foreign Company)", address: " ", tel: " ", country: " ", priceTerm: " ", paymentTerms: "T/T", currencySymbol: 'US$', currencyCode: 'USD',
                products: [ { id: 'JC-108A-08', desc: 'Bottom Housing-JC-8GB', price: 1.5 }, { id: 'JC-108B-08', desc: 'Bottom Housing-JC-8GB', price: 1.4 }, { id: 'JC-109A-08', desc: 'Bottom Housing-JC-8GB', price: 2.0 } ],
                findQuantities: findQuantitiesAnXinUSD,
                extraInvoiceLines: (p) => `<tr class="h-4"><td class="no-border"></td><td class="no-border"></td><td class="no-border"></td><td class="no-border"></td></tr>`,
            },
            'buy_foreign_eur': {
                type: 'buy', name: "外國公司 (Foreign Company)", address: " ", tel: " ", country: " ", priceTerm: " ", paymentTerms: "T/T", currencySymbol: '€', currencyCode: 'EUR',
                products: [ { id: 'JC-108A-08', desc: 'Bottom Housing-JC-8GB', price: 1.40 }, { id: 'JC-108B-08', desc: 'Bottom Housing-JC-8GB', price: 1.30 }, { id: 'JC-109A-08', desc: 'Bottom Housing-JC-8GB', price: 1.85 } ],
                findQuantities: findQuantitiesAnXinEur,
                extraInvoiceLines: (p) => `<tr class="h-4"><td class="no-border"></td><td class="no-border"></td><td class="no-border"></td><td class="no-border"></td></tr>`,
            },
        };

        // --- ALL FUNCTION DEFINITIONS ---

        function adjustDate(yyyymmdd, days) {
            const year = parseInt(yyyymmdd.substring(0, 4), 10);
            const month = parseInt(yyyymmdd.substring(4, 6), 10) - 1; // JS months are 0-indexed
            const day = parseInt(yyyymmdd.substring(6, 8), 10);
            
            const date = new Date(Date.UTC(year, month, day));
            date.setUTCDate(date.getUTCDate() + days); // Add or subtract days

            const newYear = date.getUTCFullYear();
            const newMonth = String(date.getUTCMonth() + 1).padStart(2, '0');
            const newDay = String(date.getUTCDate()).padStart(2, '0');

            return `${newYear}${newMonth}${newDay}`;
        }

        function findQuantitiesAnXinUSD(totalAmount) {
            const companyKey = document.getElementById('company').value;
            const prices = companyConfigs[companyKey].products.map(p => p.price);
            const useFlexibleUnits = document.getElementById('flexible-quantity-checkbox').checked;

            const solveByUnit = (amount, unit) => {
                let found = [];
                const diffLimit = unit >= 1000 ? 10 : (unit >= 100 ? 100 : 1000);
                 const p_unit = { p1: prices[0] * unit, p2: prices[1] * unit, p3: prices[2] * unit };
                const minQtyUnit = unit >= 1000 ? 1 : (unit >= 100 ? 10 : (unit >= 10 ? 10 : 1));
                
                let maxQ1 = Math.floor(amount / (prices[0] * unit));
                for (let q1 = maxQ1; q1 >= minQtyUnit; q1--) {
                    const maxQ2 = Math.min(q1, Math.floor((amount - q1 * p_unit.p1) / p_unit.p2));
                    for (let q2 = maxQ2; q2 >= minQtyUnit; q2--) {
                        const remainder = amount - (q1 * p_unit.p1) - (q2 * p_unit.p2);
                        if (remainder > 0 && Math.abs(remainder % p_unit.p3) < 0.01) {
                            const q3 = Math.round(remainder / p_unit.p3);
                            if (q1 >= q2 && q2 > q3 && q3 >= minQtyUnit && (q1 - q3) <= diffLimit) {
                                found.push({ q1: q1 * unit, q2: q2 * unit, q3: q3 * unit });
                            }
                        }
                    }
                }
                return found.length > 0 ? found : null;
            };

            const solveForAmount = (amount) => {
                 if (useFlexibleUnits) {
                    const tiers = [1000, 100, 10, 1];
                    for (const unit of tiers) {
                        const solutions = solveByUnit(amount, unit);
                        if (solutions) return solutions;
                    }
                } else {
                    let solutions = solveByUnit(amount, 1000);
                    if (solutions) return solutions;
                    if (Math.abs((amount % 1000) - 500) < 0.01) {
                         solutions = solveByUnit(amount, 100);
                         if (solutions) return solutions;
                    }
                }
                return null;
            }

            let solutions = solveForAmount(totalAmount);
            if (solutions) return solutions;

            let adjustedAmount = totalAmount;
            const searchLimit = totalAmount + 2000;
            while (adjustedAmount < searchLimit) {
                adjustedAmount = parseFloat((adjustedAmount + 0.05).toFixed(2));
                solutions = solveForAmount(adjustedAmount);
                if (solutions) {
                    const statusDiv = document.getElementById('status');
                    statusDiv.innerHTML = `<span class="font-bold">注意：</span>您輸入的金額 ${totalAmount.toLocaleString()} 無法找到組合。<br>已自動<span class="font-bold">向上調整</span>為最接近的有效金額 <span class="font-bold">${adjustedAmount.toLocaleString()}</span> 並生成發票。`;
                    statusDiv.className = 'mt-4 text-center text-orange-600 font-semibold';
                    solutions.forEach(s => s.adjustedAmount = adjustedAmount);
                    return solutions;
                }
            }
            return [];
        }

        function findQuantitiesAnXinEur(totalAmount) {
            const companyKey = document.getElementById('company').value;
            const prices = companyConfigs[companyKey].products;
            const p1 = prices[0].price, p2 = prices[1].price, p3 = prices[2].price;
            
            const p1_c = p1 * 100, p2_c = p2 * 100, p3_c = p3 * 100;
            const sum_p_c = p1_c + p2_c + p3_c;
            const p2p3_c = p2_c + p3_c;

            const searchLimit = 2000; 
            let solutions = [];
            const seen = new Set();

            const findAndStoreSolutions = (checkFn) => {
                 for (let d1 = 0; d1 <= searchLimit; d1++) {
                    for (let d2 = 1; d2 <= searchLimit; d2++) {
                        if (solutions.length >= 20) return;
                        const numerator = (totalAmount * 100) + (p2p3_c * d1) + (p3_c * d2);
                        
                        if (numerator > 0 && numerator % sum_p_c === 0) {
                            const q1 = numerator / sum_p_c;
                            const q2 = q1 - d1;
                            const q3 = q2 - d2;

                            if (q1 > 0 && q2 > 0 && q3 > 0 && Number.isInteger(q1) && Number.isInteger(q2) && Number.isInteger(q3)) {
                                if (checkFn({q1, q2, q3})) {
                                    const key = `${q1}-${q2}-${q3}`;
                                    if (!seen.has(key)) {
                                        solutions.push({ q1, q2, q3 });
                                        seen.add(key);
                                    }
                                }
                            }
                        }
                    }
                }
            };

            findAndStoreSolutions(q => q.q1 % 10 === 0 && q.q2 % 10 === 0 && q.q3 % 10 === 0);
            if (solutions.length < 20) {
                findAndStoreSolutions(q => q.q1 % 5 === 0 && q.q2 % 5 === 0 && q.q3 % 5 === 0);
            }
            if (solutions.length < 20) {
                findAndStoreSolutions(q => true);
            }

            return solutions;
        }

        function findQuantitiesWinTeam(totalAmount) {
            const prices = companyConfigs.winteam.products.map(p => p.price);
            const p1 = prices[0], p2 = prices[1], p3 = prices[2];
            const gcd = 600; 
            let solutions = [];
            const seen = new Set();

            let adjustedAmount = totalAmount;
            if (totalAmount % gcd !== 0) {
                adjustedAmount = totalAmount - (totalAmount % gcd) + gcd;
            }
            
            // Pass 1: Prioritize paired sets (q1 = q2) for balance
            const p_set = p1 + p2;
            const max_sets = Math.floor(adjustedAmount / p_set);
            for (let q_set = max_sets; q_set > 0; q_set--) {
                const remainder = adjustedAmount - (q_set * p_set);
                if (remainder >= 0 && remainder % p3 === 0) {
                    const q3 = remainder / p3;
                    const sol = { q1: q_set, q2: q_set, q3: q3 };
                    const key = `${sol.q1}-${sol.q2}-${sol.q3}`;
                    if (!seen.has(key)) {
                        solutions.push(sol);
                        seen.add(key);
                    }
                }
            }

            // Pass 2: Find all other possible combinations
            const maxQ1 = Math.floor(adjustedAmount / p1);
            for (let q1 = maxQ1; q1 >= 0; q1--) {
                const remainder1 = adjustedAmount - (q1 * p1);
                const maxQ2 = Math.floor(remainder1 / p2);
                for (let q2 = maxQ2; q2 >= 0; q2--) {
                    const remainder2 = remainder1 - (q2 * p2);
                    if (remainder2 >= 0 && remainder2 % p3 === 0) {
                        const q3 = remainder2 / p3;
                        if (q1 === 0 && q2 === 0 && q3 === 0) continue;

                        const sol = { q1, q2, q3 };
                        const key = `${sol.q1}-${sol.q2}-${sol.q3}`;
                        if (!seen.has(key)) {
                            solutions.push(sol);
                            seen.add(key);
                        }
                    }
                }
            }
            
            if (solutions.length > 0 && totalAmount !== adjustedAmount) {
                const statusDiv = document.getElementById('status');
                statusDiv.innerHTML = `<span class="font-bold">注意：</span>您輸入的金額 ${totalAmount.toLocaleString()} 無法整除。<br>已自動<span class="font-bold">向上調整</span>為最接近的有效金額 <span class="font-bold">${adjustedAmount.toLocaleString()}</span> 並生成發票。`;
                statusDiv.className = 'mt-4 text-center text-orange-600 font-semibold';
                solutions.forEach(s => s.adjustedAmount = adjustedAmount);
            }
            
            return solutions;
        }

        function findQuantitiesStyleUp(totalAmount) {
            const prices = companyConfigs.styleup.products.map(p => p.price);
            const priceSum = prices[0] + prices[1] + prices[2];
            if (totalAmount > 0 && totalAmount % priceSum === 0) {
                 const q = totalAmount / priceSum;
                 if (q > 0) return [{ q1: q, q2: q, q3: q }];
            }
            return [];
        }
        
        function formatDate(yyyymmdd) {
            const year = yyyymmdd.substring(0, 4); const month = yyyymmdd.substring(4, 6); const day = yyyymmdd.substring(6, 8);
            const date = new Date(`${year}-${month}-${day}T00:00:00Z`);
            const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            return `${monthNames[date.getUTCMonth()]}.${day}.${year}`;
        }

        function formatCurrency(num, symbol = 'US$') { return `${symbol}${num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`; }
        function numberToCurrency(num) { return num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }

        function generateInvoiceHTML(config, dateInput, totalAmount, quantities) {
            const invoiceNo = `TOP${dateInput}001`;
            const formattedDate = formatDate(dateInput);
            
            const isBuyInvoice = config.type === 'buy';
            const seller = isBuyInvoice ? { name: config.name, address: config.address, tel: config.tel } : TOPTEC_GLOBAL;
            const buyer = isBuyInvoice ? TOPTEC_GLOBAL : { name: config.name, address: config.address, tel: config.tel };

            const sellerLogoHTML = isBuyInvoice 
                ? `<div class="text-left font-bold text-lg">${seller.name}</div>`
                : `<svg width="120" height="80" viewBox="0 0 250 100" class="mr-2">
                      <rect width="100%" height="100%" fill="none"/>
                      <text x="125" y="60" text-anchor="middle" font-size="40" font-weight="bold" font-family="sans-serif">TOPTEC</text>
                   </svg>`;

            const tableRows = config.products.map((p, i) => {
                const qty = quantities[`q${i+1}`];
                if (!qty || qty === 0) return '';
                const unitPrice = (config.name.startsWith("Converge")) ? totalAmount : p.price;
                const amount = qty * unitPrice;
                return `
                    <tr><td>${p.id}</td><td>${qty.toLocaleString()}</td><td>${numberToCurrency(unitPrice)}</td><td>${numberToCurrency(amount)}</td></tr>
                    ${p.desc ? `<tr><td class="text-left pl-4">${p.desc}</td><td></td><td></td><td></td></tr>` : ''}
                    ${config.extraInvoiceLines(p)}
                `;
            }).join('');

            const headerDetailsHTML = `
                <div class="flex justify-between">
                    ${config.country.trim() ? `<p class="w-1/3"><strong>Country of Origin:</strong> ${config.country}</p>` : '<p class="w-1/3"></p>'}
                    ${config.priceTerm.trim() ? `<p class="w-1/3"><strong>PRICE TERM:</strong> ${config.priceTerm}</p>` : '<p class="w-1/3"></p>'}
                    ${config.paymentTerms.trim() ? `<p class="w-1/3"><strong>Payment Terms:</strong> ${config.paymentTerms}</p>` : '<p class="w-1/3"></p>'}
                </div>
                ${config.priceTerm.trim() ? `<div class="flex justify-between"><p class="w-1/3"><strong>SHIPPED:</strong> </p><p class="w-1/3"><strong>ON/ABOUT BOARD:</strong> </p><p class="w-1/3"></p></div>` : ''}
            `;

            const invoiceHTML = `
                <div class="flex justify-between items-start mb-4">
                     <div class="flex items-center">${sellerLogoHTML}</div>
                    <div class="text-left text-xs">
                        <p class="font-bold text-base">${seller.name}</p>
                        <p>${seller.address.replace(/\n/g, '<br>')}</p>
                        <p>TEL: ${seller.tel}</p>
                    </div>
                </div>
                <h1 class="text-center font-bold text-xl mb-4 underline">COMMERCIAL INVOICE</h1>
                <div class="flex justify-between mb-2">
                    <div class="w-2/3">
                        <p><strong>BUYER:</strong> ${buyer.name}</p>
                        <p><strong>BUYER ADD:</strong> ${buyer.address.replace(/\n/g, '<br>')}</p>
                        <p><strong>TEL:</strong> ${buyer.tel}</p>
                    </div>
                    <div class="w-1/3 text-left">
                        <p><strong>INV.No.:</strong> <span id="inv-no">${invoiceNo}</span></p><p><strong>Date:</strong> ${formattedDate}</p>
                    </div>
                </div>
                <div class="border-y-2 border-black py-1 mb-2">${headerDetailsHTML}</div>
                <table class="w-full invoice-table mb-2">
                    <thead>
                        <tr class="font-bold"><td class="w-1/4">ITEM NO.</td><td class="w-1/4">Q'TY</td><td class="w-1/4">UNIT PRC</td><td class="w-1/4">TTL AMT</td></tr>
                        <tr class="font-bold"><td></td><td>PCS</td><td>${config.currencyCode}/PCS</td><td>${config.currencyCode}</td></tr>
                    </thead>
                    <tbody>${tableRows}</tbody>
                </table>
                <div class="flex justify-end mt-4">
                    <div class="w-2/5">
                         <div class="flex justify-between">
                            <strong>SAY TOTAL:</strong>
                            <strong id="say-total-amount" class="text-right flex-1 ml-2"></strong>
                        </div>
                        <div class="flex justify-between border-t border-black pt-1 mt-1">
                            <strong>TOTAL:</strong><strong>${formatCurrency(totalAmount, config.currencySymbol)}</strong>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end" style="margin-top: 60px;"><div class="w-1/3 text-center"><div class="border-t border-black pt-1">AUTHORIZED SIGNATURE</div></div></div>
                <table id="invoice-table-export" class="hidden"></table>
            `;
            document.getElementById('invoice-preview').innerHTML = invoiceHTML;
            generateHiddenTableForExport(config, dateInput, totalAmount, quantities);
        }

        function generateHiddenTableForExport(config, dateInput, totalAmount, quantities) {
            const invoiceNo = `TOP${dateInput}001`;
            const formattedDate = formatDate(dateInput);
            
            const isBuyInvoice = config.type === 'buy';
            const seller = isBuyInvoice ? { name: config.name, address: config.address, tel: config.tel } : TOPTEC_GLOBAL;
            const buyer = isBuyInvoice ? TOPTEC_GLOBAL : { name: config.name, address: config.address, tel: config.tel };

            let headerRows = `
                <tr><td>Country of Origin：${config.country || ''}</td><td></td><td></td>
                ${config.priceTerm.trim() ? `<td>PRICE TERM: ${config.priceTerm}</td>` : '<td></td>'}
                <td></td><td></td><td colspan="3">Payment Terms : ${config.paymentTerms || ''}</td></tr>
                ${config.priceTerm.trim() ? `<tr><td>SHIPPED :</td><td></td><td></td><td>ON/ABOUT BOARD:</td><td></td><td></td><td></td><td></td><td></td></tr>` : ''}
            `;
            let tableRows = '';
            config.products.forEach((p, i) => {
                const qty = quantities[`q${i+1}`];
                if (!qty || qty === 0) return;
                const unitPrice = (config.name.startsWith("Converge")) ? totalAmount : p.price;
                const amount = qty * unitPrice;
                tableRows += `
                    <tr><td>${p.id}</td><td></td><td></td><td>${qty}</td><td></td><td>${unitPrice.toFixed(2)}</td><td></td><td colspan="2">${amount.toFixed(2)}</td></tr>
                    ${p.desc ? `<tr><td colspan="9">${p.desc}</td></tr><tr><td colspan="9"></td></tr>` : '<tr><td colspan="9"></td></tr>'}
                `;
            });
            
            const fullExportHTML = `
                <tr><td colspan="3"></td><td colspan="6">${seller.name}</td></tr>
                <tr><td colspan="3"></td><td colspan="6">${seller.address.replace(/\n/g, ' ')}</td></tr>
                <tr><td colspan="3"></td><td colspan="6">TEL: ${seller.tel}</td></tr>
                <tr><td colspan="9"></td></tr>
                <tr><td colspan="9" style="font-weight:bold; text-align:center;">COMMERCIAL INVOICE</td></tr>
                <tr><td colspan="9"></td></tr>
                <tr><td colspan="5">BUYER：${buyer.name}</td><td></td><td>INV.No.:</td><td colspan="2">${invoiceNo}</td></tr>
                <tr><td colspan="5">BUYER ADD：${buyer.address.replace(/\n/g, ' ')}</td><td></td><td>Date:</td><td colspan="2">${formattedDate}</td></tr>
                <tr><td colspan="5">TEL: ${buyer.tel}</td><td></td><td></td><td></td><td></td></tr>
                <tr><td colspan="9"></td></tr>
                ${headerRows}
                <tr><td colspan="9"></td></tr>
                <tr><td>ITEM NO.</td><td></td><td></td><td>Q'TY</td><td></td><td>UNT PRC</td><td></td><td colspan="2">TTL AMT</td></tr>
                <tr><td></td><td></td><td></td><td>PCS</td><td></td><td>${config.currencyCode}/PCS</td><td></td><td colspan="2">${config.currencyCode}</td></tr>
                <tr><td colspan="9"></td></tr>
                ${tableRows}
                <tr><td colspan="6"></td><td>TOTAL</td><td colspan="2">${totalAmount.toFixed(2)}</td></tr>
                 <tr><td colspan="2">SAY TOTAL:</td><td colspan="7" id="say-total-amount-export"></td></tr>
            `;
            document.getElementById('invoice-table-export').innerHTML = fullExportHTML;
        }

        async function callGeminiAPI(payload) {
            if (!API_KEY) { alert('API 金鑰未設定，無法使用智慧功能。'); return null; }
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
            try {
                const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API call failed with status: ${response.status}`);
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!text) throw new Error("Invalid response structure from API.");
                return text;
            } catch (error) { console.error("Gemini API Error:", error); return null; }
        }
        
        async function generateSayTotal(amount, currencyCode) {
            const sayTotalEl = document.getElementById('say-total-amount');
            const sayTotalExportEl = document.getElementById('say-total-amount-export');
            if (!sayTotalEl || !sayTotalExportEl) return;

            sayTotalEl.innerHTML = `<span class="italic text-gray-500">✨ Generating...</span>`;
            sayTotalExportEl.textContent = 'Generating...';

            const prompt = `For a commercial invoice, write out the following monetary value in capital English letters, followed by the word "ONLY".
- If the value is a whole number, do not include cents.
- If the value has cents, express them as a fraction like "AND XX/100".

Example for 123 USD: US DOLLARS ONE HUNDRED TWENTY-THREE ONLY
Example for 123.45 USD: US DOLLARS ONE HUNDRED TWENTY-THREE AND 45/100 ONLY

Value: ${amount.toFixed(2)}
Currency: ${currencyCode}
Provide only the resulting text.`;

            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            const resultText = await callGeminiAPI(payload);

            if (resultText) {
                const cleanedText = resultText.trim().toUpperCase();
                sayTotalEl.textContent = cleanedText;
                sayTotalExportEl.textContent = cleanedText;
            } else {
                sayTotalEl.textContent = 'Could not generate.';
                sayTotalExportEl.textContent = '';
            }
        }

        function copyEmailToClipboard(button) {
            const textToCopy = button.previousElementSibling.value;
            navigator.clipboard.writeText(textToCopy).then(() => {
                const originalText = button.textContent; button.textContent = '已複製!';
                setTimeout(() => { button.textContent = originalText; }, 2000);
            }).catch(err => { console.error('無法複製文字: ', err); });
        }
        function showModal(id, content) {
            const modal = document.getElementById(id);
            modal.innerHTML = content; modal.classList.remove('hidden');
        }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

        async function generatePackingList() {
            const modalId = 'packingListModal';
            showModal(modalId, `<div class="modal-content"><h2 class="text-xl font-bold mb-4">✨ 正在生成裝箱單...</h2><div class="flex justify-center items-center h-24"><div class="loader"></div></div></div>`);
            const itemsString = currentInvoiceData.items.filter(item => item && item.qty > 0).map(item => `- ${item.id}: ${item.qty} pcs`).join('\n');
            const prompt = `您是一位物流助理。根據以下品項和數量，創建一份詳細的裝箱單。請為每個品項合理估算箱數(cartons)、每箱數量(quantity_per_carton)、淨重(net_weight_kgs)、毛重(gross_weight_kgs)和體積(volume_cbm)，並確保每個品項的總數量與輸入相符。品項描述均為 'Bottom Housing'。\n\n${itemsString}\n\n請以 JSON 格式提供輸出，不要包含任何 markdown 符號。`;
            const payload = { contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json", responseSchema: { type: "OBJECT", properties: { packing_list_items: { type: "ARRAY", items: { type: "OBJECT", properties: { item_no: { type: "STRING" }, description: { type: "STRING" }, cartons: { type: "NUMBER" }, total_quantity: { type: "NUMBER" }, net_weight_kgs: { type: "NUMBER" }, gross_weight_kgs: { type: "NUMBER" }, volume_cbm: { type: "NUMBER" } } } }, summary: { type: "OBJECT", properties: { total_cartons: { type: "NUMBER" }, total_net_weight: { type: "NUMBER" }, total_gross_weight: { type: "NUMBER" }, total_volume: { type: "NUMBER" } } } } } } };
            const resultText = await callGeminiAPI(payload);
            if (resultText) {
                try {
                    const data = JSON.parse(resultText);
                    let tableRows = data.packing_list_items.map(item => `<tr><td>${item.item_no}</td><td>${item.description}</td><td>${item.cartons}</td><td>${item.total_quantity.toLocaleString()}</td><td>${item.net_weight_kgs.toFixed(2)}</td><td>${item.gross_weight_kgs.toFixed(2)}</td><td>${item.volume_cbm.toFixed(3)}</td></tr>`).join('');
                    let summary = data.summary;
                    let summaryRow = `<tr class="font-bold bg-gray-100"><td colspan="2">TOTAL</td><td>${summary.total_cartons}</td><td></td><td>${summary.total_net_weight.toFixed(2)}</td><td>${summary.total_gross_weight.toFixed(2)}</td><td>${summary.total_volume.toFixed(3)}</td></tr>`;
                    const modalContent = `<div class="modal-content"><div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold">✨ 智慧裝箱單</h2><button onclick="closeModal('${modalId}')" class="text-gray-500 hover:text-gray-800 font-bold text-2xl">×</button></div><div class="overflow-x-auto"><table class="w-full packing-table"><thead><tr><th>品項號碼</th><th>描述</th><th>箱數 (CTN)</th><th>總數量 (PCS)</th><th>淨重 (KGS)</th><th>毛重 (KGS)</th><th>體積 (CBM)</th></tr></thead><tbody>${tableRows}${summaryRow}</tbody></table></div></div>`;
                    showModal(modalId, modalContent);
                } catch (e) { showModal(modalId, `<div class="modal-content"><p class="text-red-500">解析裝箱單時發生錯誤。</p><button onclick="closeModal('${modalId}')" class="mt-4 bg-gray-300 px-4 py-2 rounded">關閉</button></div>`); }
            } else { showModal(modalId, `<div class="modal-content"><p class="text-red-500">無法生成裝箱單，請稍後再試。</p><button onclick="closeModal('${modalId}')" class="mt-4 bg-gray-300 px-4 py-2 rounded">關閉</button></div>`); }
        }
        async function generateEmail() {
            const modalId = 'emailModal';
            showModal(modalId, `<div class="modal-content"><h2 class="text-xl font-bold mb-4">✨ 正在草擬郵件...</h2><div class="flex justify-center items-center h-24"><div class="loader"></div></div></div>`);
            const prompt = `請以繁體中文草擬一封專業的商業電子郵件給客戶。\n- 客戶名稱: ${currentInvoiceData.buyer}\n- 發票號碼: ${currentInvoiceData.invoiceNo}\n- 發票日期: ${currentInvoiceData.date}\n- 總金額: ${currentInvoiceData.totalAmount}\n- 郵件內容應包含：通知客戶附件是新的商業發票，並提及發票號碼和總金額。最後以禮貌的問候作結。\n- 風格：專業、簡潔、有禮。`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            const resultText = await callGeminiAPI(payload);
            if (resultText) {
                const modalContent = `<div class="modal-content"><div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold">✨ 郵件草稿</h2><button onclick="closeModal('${modalId}')" class="text-gray-500 hover:text-gray-800 font-bold text-2xl">×</button></div><textarea readonly class="w-full h-64 p-2 border rounded bg-gray-50">${resultText}</textarea><div class="text-right mt-4"><button onclick="copyEmailToClipboard(this)" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">複製內容</button></div></div>`;
                showModal(modalId, modalContent);
            } else { showModal(modalId, `<div class="modal-content"><p class="text-red-500">無法生成郵件，請稍後再試。</p><button onclick="closeModal('${modalId}')" class="mt-4 bg-gray-300 px-4 py-2 rounded">關閉</button></div>`); }
        }
        
        // --- MAIN GENERATION LOGIC ---
        function renderInvoice(quantities) {
            const { config, dateInput, originalAmount } = generationArgs;
            const finalTotalAmount = quantities.adjustedAmount || originalAmount;

            generateInvoiceHTML(config, dateInput, finalTotalAmount, quantities);
            
            // This needs to be called after the HTML elements are created
            generateSayTotal(finalTotalAmount, config.currencyCode);

            const buyerForData = config.type === 'buy' ? TOPTEC_GLOBAL.name : config.name;
            currentInvoiceData = {
                date: formatDate(dateInput),
                invoiceNo: `TOP${dateInput}001`,
                totalAmount: formatCurrency(finalTotalAmount, config.currencySymbol),
                buyer: buyerForData,
                items: config.products.map((p, i) => ({ id: p.id, qty: quantities[`q${i+1}`] }))
            };
        }

        // --- EVENT LISTENERS ---
        document.getElementById('company').addEventListener('change', (e) => {
            const jcUsdProfiles = ['anxin', 'buy_foreign_usd'];
            const flexibleContainer = document.getElementById('flexible-quantity-container');
            if (jcUsdProfiles.includes(e.target.value)) {
                flexibleContainer.classList.remove('hidden');
            } else {
                flexibleContainer.classList.add('hidden');
            }
        });
        // Run on page load to set initial state
        document.getElementById('company').dispatchEvent(new Event('change'));

        document.getElementById('generateBtn').addEventListener('click', () => {
            const companyKey = document.getElementById('company').value;
            const config = companyConfigs[companyKey];
            const dateInput = document.getElementById('date').value;
            const totalAmountInput = document.getElementById('totalAmount').value;
            const statusDiv = document.getElementById('status');
            const invoiceWrapper = document.getElementById('invoice-wrapper');
            const findNextBtn = document.getElementById('findNextBtn');

            statusDiv.innerHTML = '';
            invoiceWrapper.classList.add('hidden');
            findNextBtn.classList.add('hidden');

            if (!/^\d{8}$/.test(dateInput)) { statusDiv.textContent = '錯誤：日期格式不正確，請使用 YYYYMMDD。'; statusDiv.className = 'mt-4 text-center text-red-600 font-semibold'; return; }
            if (!totalAmountInput || isNaN(parseFloat(totalAmountInput)) || parseFloat(totalAmountInput) <= 0) { statusDiv.textContent = '錯誤：總金額必須是有效的正數。'; statusDiv.className = 'mt-4 text-center text-red-600 font-semibold'; return; }

            const isDateAdjusted = document.getElementById('date-adjust-checkbox').checked;
            let finalDateInput = dateInput;
            if (isDateAdjusted) {
                finalDateInput = adjustDate(dateInput, -5);
            }

            const totalAmount = parseFloat(totalAmountInput);
            
            statusDiv.textContent = '請稍候，正在計算並生成文件...';
            statusDiv.className = 'mt-4 text-center text-blue-600 font-semibold animate-pulse';

            setTimeout(() => {
                generationArgs = { config, dateInput: finalDateInput, originalAmount: totalAmount };
                foundSolutions = config.findQuantities(totalAmount);
                
                if (!foundSolutions || foundSolutions.length === 0) {
                    statusDiv.textContent = '錯誤：找不到符合條件的數量組合，請檢查總金額。';
                    statusDiv.className = 'mt-4 text-center text-red-600 font-semibold';
                    return;
                }
                
                currentSolutionIndex = 0;
                renderInvoice(foundSolutions[currentSolutionIndex]);

                if (!statusDiv.innerHTML.includes('注意')) {
                    statusDiv.textContent = '文件已成功生成！';
                    statusDiv.className = 'mt-4 text-center text-green-600 font-semibold';
                }
                
                if (foundSolutions.length > 1) {
                    findNextBtn.classList.remove('hidden');
                }

                invoiceWrapper.classList.remove('hidden');
                invoiceWrapper.scrollIntoView({ behavior: 'smooth' });
            }, 100);
        });
        
        document.getElementById('findNextBtn').addEventListener('click', () => {
            if (foundSolutions.length === 0) return;
            currentSolutionIndex = (currentSolutionIndex + 1) % foundSolutions.length;
            renderInvoice(foundSolutions[currentSolutionIndex]);
        });

        document.getElementById('downloadBtn').addEventListener('click', function() {
            const invNo = document.getElementById('inv-no').textContent;
            const table = document.getElementById('invoice-table-export');
            const ws = XLSX.utils.table_to_sheet(table, {skipHeader: true});
            ws['!cols'] = [ {wch:12}, {wch:12}, {wch:12}, {wch:8}, {wch:8}, {wch:8}, {wch:12}, {wch:12}, {wch:12} ];
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Invoice");
            XLSX.writeFile(wb, `${invNo}.xlsx`);
        });

        document.getElementById('printBtn').addEventListener('click', () => window.print());
        document.getElementById('packingListBtn').addEventListener('click', generatePackingList);
        document.getElementById('emailBtn').addEventListener('click', generateEmail);
    </script>
</body>
</html>

